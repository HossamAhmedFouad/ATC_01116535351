<div class="profile-container">
  <mat-sidenav-container>
    <mat-sidenav
      #sidenav
      mode="side"
      [opened]="isSidenavOpen"
      [class.collapsed]="!isSidenavOpen"
    >
      <app-sidebar-nav
        [isOpen]="isSidenavOpen"
        [currentSection]="currentSection"
        [navItems]="navItems"
        [userEmail]="user?.email"
        [username]="user?.username"
        (toggleSidenav)="toggleSidenav()"
        (sectionChange)="navigateToSection($event)"
      >
      </app-sidebar-nav>
    </mat-sidenav>

    <mat-sidenav-content>
      <div class="profile-content">
        <!-- Floating button to reopen sidenav -->
        <button
          mat-fab
          color="primary"
          class="reopen-sidenav-btn"
          *ngIf="!isSidenavOpen"
          (click)="toggleSidenav()"
        >
          <mat-icon>menu</mat-icon>
        </button>

        <mat-progress-spinner
          *ngIf="isLoading"
          mode="indeterminate"
          diameter="40"
          class="loading-spinner"
        ></mat-progress-spinner>

        <!-- Personal Info Section -->
        <section
          *ngIf="currentSection === 'personal-info' && !isLoading"
          class="profile-section"
        >
          <mat-card class="modern-card">
            <mat-card-header>
              <div class="profile-header">
                <div class="profile-avatar">
                  <div class="avatar-placeholder">
                    <mat-icon>account_circle</mat-icon>
                  </div>
                </div>
                <div class="profile-title">
                  <mat-card-title>Personal Information</mat-card-title>
                  <mat-card-subtitle
                    >Update your profile details</mat-card-subtitle
                  >
                </div>
              </div>
              <button
                mat-icon-button
                color="primary"
                (click)="personalInfoForm.reset()"
                matTooltip="Reset Form"
              >
                <mat-icon>refresh</mat-icon>
              </button>
            </mat-card-header>
            <mat-card-content>
              <form
                [formGroup]="personalInfoForm"
                (ngSubmit)="updatePersonalInfo()"
              >
                <div class="form-grid">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Username</mat-label>
                    <input matInput formControlName="username" required />
                    <mat-icon matSuffix>person</mat-icon>
                    <mat-error
                      *ngIf="
                        personalInfoForm.get('username')?.hasError('required')
                      "
                    >
                      Username is required
                    </mat-error>
                    <mat-error
                      *ngIf="
                        personalInfoForm.get('username')?.hasError('minlength')
                      "
                    >
                      Username must be at least 3 characters
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Email</mat-label>
                    <input
                      matInput
                      formControlName="email"
                      type="email"
                      required
                    />
                    <mat-icon matSuffix>email</mat-icon>
                    <mat-error
                      *ngIf="
                        personalInfoForm.get('email')?.hasError('required')
                      "
                    >
                      Email is required
                    </mat-error>
                    <mat-error
                      *ngIf="personalInfoForm.get('email')?.hasError('email')"
                    >
                      Please enter a valid email
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Phone Number</mat-label>
                    <input matInput formControlName="phone" />
                    <mat-icon matSuffix>phone</mat-icon>
                    <mat-error
                      *ngIf="personalInfoForm.get('phone')?.hasError('pattern')"
                    >
                      Please enter a valid phone number
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Location</mat-label>
                    <input matInput formControlName="location" />
                    <mat-icon matSuffix>location_on</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Bio</mat-label>
                    <textarea
                      matInput
                      formControlName="bio"
                      rows="4"
                      maxlength="500"
                    ></textarea>
                    <mat-hint align="end"
                      >{{
                        personalInfoForm.get("bio")?.value?.length || 0
                      }}/500</mat-hint
                    >
                  </mat-form-field>
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="!personalInfoForm.valid || isUpdating"
                  >
                    <mat-icon>save</mat-icon>
                    Update Profile
                    <mat-progress-spinner
                      *ngIf="isUpdating"
                      mode="indeterminate"
                      diameter="20"
                      class="button-spinner"
                    ></mat-progress-spinner>
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </section>

        <!-- Security Section -->
        <section
          *ngIf="currentSection === 'security' && !isLoading"
          class="profile-section"
        >
          <mat-card class="modern-card">
            <mat-card-header>
              <div class="profile-title">
                <mat-card-title>Security Settings</mat-card-title>
                <mat-card-subtitle
                  >Manage your account security</mat-card-subtitle
                >
              </div>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="securityForm" (ngSubmit)="updatePassword()">
                <div class="form-grid">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Current Password</mat-label>
                    <input
                      matInput
                      formControlName="currentPassword"
                      type="password"
                      required
                    />
                    <mat-icon matSuffix>lock</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>New Password</mat-label>
                    <input
                      matInput
                      formControlName="newPassword"
                      type="password"
                      required
                    />
                    <mat-icon matSuffix>vpn_key</mat-icon>
                    <mat-error
                      *ngIf="
                        securityForm.get('newPassword')?.hasError('minlength')
                      "
                    >
                      Password must be at least 8 characters
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Confirm New Password</mat-label>
                    <input
                      matInput
                      formControlName="confirmPassword"
                      type="password"
                      required
                    />
                    <mat-icon matSuffix>vpn_key</mat-icon>
                    <mat-error *ngIf="securityForm.hasError('mismatch')">
                      Passwords do not match
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="security-info">
                  <mat-icon color="primary">info</mat-icon>
                  <p>
                    Password must be at least 8 characters and include a mix of
                    letters, numbers, and special characters.
                  </p>
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="!securityForm.valid || isUpdating"
                  >
                    <mat-icon>security</mat-icon>
                    Update Password
                    <mat-progress-spinner
                      *ngIf="isUpdating"
                      mode="indeterminate"
                      diameter="20"
                      class="button-spinner"
                    ></mat-progress-spinner>
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </section>

        <!-- Settings Section -->
        <section
          *ngIf="currentSection === 'settings' && !isLoading"
          class="profile-section"
        >
          <mat-card class="modern-card">
            <mat-card-header>
              <div class="profile-title">
                <mat-card-title>Website Settings</mat-card-title>
                <mat-card-subtitle>Customize your experience</mat-card-subtitle>
              </div>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="settingsForm" (ngSubmit)="updateSettings()">
                <div class="settings-group">
                  <h3>Preferences</h3>
                  <div class="form-grid">
                    <mat-form-field appearance="outline">
                      <mat-label>Language</mat-label>
                      <mat-select formControlName="language">
                        <mat-option
                          *ngFor="let lang of languages"
                          [value]="lang.code"
                        >
                          {{ lang.name }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matSuffix>language</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Timezone</mat-label>
                      <mat-select formControlName="timezone">
                        <mat-option
                          *ngFor="let tz of timezones"
                          [value]="tz.value"
                        >
                          {{ tz.label }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matSuffix>schedule</mat-icon>
                    </mat-form-field>
                  </div>
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="isUpdating"
                  >
                    <mat-icon>save</mat-icon>
                    Save Settings
                    <mat-progress-spinner
                      *ngIf="isUpdating"
                      mode="indeterminate"
                      diameter="20"
                      class="button-spinner"
                    ></mat-progress-spinner>
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </section>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>
